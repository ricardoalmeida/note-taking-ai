# Story 1.5: Search and Organization Features

## Status
Draft

## Story
**As a** professional user,
**I want** to search across all my content and organize it with tags and folders,
**so that** I can efficiently find and categorize my notes, documents, and recordings.

## Acceptance Criteria
1. Global search functionality across notes content, document text, and voice transcriptions with highlighting
2. Tagging system with AI-generated and user-defined tags for content categorization
3. Folder structure for organizing content with drag-and-drop capabilities and nested folders
4. Existing content system seamlessly supports tags and folder organization without data loss
5. New functionality follows existing oRPC API pattern for search queries and organization operations
6. Integration with current database schema maintains performance standards for content retrieval
7. Search functionality and organization features covered by appropriate tests including search accuracy and performance
8. Search and organization UI follows existing Shadcn-ui patterns with intuitive user experience
9. No regression in existing content creation, editing, or viewing functionality verified

## Tasks / Subtasks

- [ ] Task 1: Create Search and Organization Database Schema (AC: 2, 3, 4, 6)
  - [ ] Create tags table with: id, name, color, user_id, created_at
  - [ ] Create folders table with: id, name, parent_folder_id, user_id, created_at, updated_at
  - [ ] Create content_tags table for many-to-many relationships: content_id, content_type, tag_id
  - [ ] Create content_folders table: content_id, content_type, folder_id
  - [ ] Add full-text search indexes to notes.content, documents.extracted_text, audio_transcriptions.transcribed_text
  - [ ] Run database migrations to create search and organization infrastructure

- [ ] Task 2: Implement Full-Text Search Backend (AC: 1, 5, 6)
  - [ ] Create search router in `apps/server/src/routers/search.ts`
  - [ ] Implement SQLite FTS (Full-Text Search) for content indexing
  - [ ] Add search endpoint with filters for content type, date range, and tags
  - [ ] Create search result ranking algorithm with relevance scoring
  - [ ] Add search highlighting functionality for matching terms
  - [ ] Implement search suggestions and autocomplete functionality

- [ ] Task 3: Build Tags Management System (AC: 2, 5)
  - [ ] Create tags API endpoints for CRUD operations
  - [ ] Implement AI-generated tag suggestions using existing AI infrastructure
  - [ ] Add tag assignment and removal operations for all content types
  - [ ] Create tag autocomplete and search functionality
  - [ ] Add tag usage statistics and popular tags discovery

- [ ] Task 4: Implement Folder Organization System (AC: 3, 5)
  - [ ] Create folders API endpoints with nested folder support
  - [ ] Implement folder hierarchy with parent-child relationships
  - [ ] Add content assignment to folders with move operations
  - [ ] Create folder breadcrumb navigation and tree view
  - [ ] Add folder sharing and permission system (basic implementation)

- [ ] Task 5: Build Search Interface Components (AC: 1, 8)
  - [ ] Create global search component in `apps/web/src/components/search/`
  - [ ] Design search results interface with content type indicators
  - [ ] Add search filters for content type, date range, and advanced options
  - [ ] Implement search result highlighting and snippet previews
  - [ ] Add search history and saved searches functionality

- [ ] Task 6: Create Tags Management UI (AC: 2, 8)
  - [ ] Build tag creation and editing interface
  - [ ] Create tag picker component with color selection
  - [ ] Add tag cloud visualization for tag discovery
  - [ ] Implement tag assignment interface for content items
  - [ ] Add AI-generated tag suggestions in content creation flows

- [ ] Task 7: Build Folder Organization Interface (AC: 3, 8)
  - [ ] Create folder tree navigation component
  - [ ] Implement drag-and-drop for content organization
  - [ ] Add folder creation, editing, and deletion interfaces
  - [ ] Create folder breadcrumb navigation component
  - [ ] Add bulk content organization operations

- [ ] Task 8: Integrate Search and Organization with Content Views (AC: 4, 9)
  - [ ] Add search and filter controls to notes, documents, and voice lists
  - [ ] Integrate tag and folder displays in content item cards
  - [ ] Update content creation flows to include tagging and folder assignment
  - [ ] Add organization options to content detail views
  - [ ] Ensure backward compatibility with unorganized content

- [ ] Task 9: Client-Side Integration and Performance (AC: 5, 7)
  - [ ] Set up oRPC client for search and organization operations
  - [ ] Integrate TanStack Query for search results caching and pagination
  - [ ] Add debounced search with real-time results
  - [ ] Implement search result virtualization for large result sets
  - [ ] Add proper error handling and loading states for all operations

- [ ] Task 10: Testing and Performance Optimization (AC: 7, 9)
  - [ ] Write unit tests for search algorithms and organization APIs
  - [ ] Create E2E tests for search workflows and organization features
  - [ ] Test search performance with large content datasets
  - [ ] Verify tag and folder operations across all content types
  - [ ] Test drag-and-drop functionality and accessibility compliance

## Dev Notes

### Testing Standards
**Location**: E2E tests in `tests/e2e/`, unit tests co-located with source files
**Framework**: Playwright for E2E testing, Bun test runner for unit tests
**Standards**: [Source: architecture.md#Testing Architecture]
- Test search functionality with various query types and content
- Verify organization features with mock folder structures and tags
- Test performance with large datasets and complex search queries
- Mock AI tag generation for consistent test results

### Architecture Context

**Technology Stack**: [Source: architecture.md#Technology Stack]
- **Backend**: Next.js API Routes, oRPC (1.8.6), Drizzle ORM (0.44.2), SQLite with LibSQL
- **Frontend**: Next.js 15.5.0 with App Router, TanStack Query (5.85.5), Shadcn-ui, Tailwind CSS
- **Search**: SQLite FTS (Full-Text Search) for content indexing and search
- **AI Integration**: Vercel AI SDK (5.0.39) with Google AI SDK for tag generation

**Project Structure**: [Source: architecture.md#Project Structure]
- **Database Schemas**: `apps/server/src/db/schema/` (tags.ts, folders.ts, content-organization.ts)
- **API Routers**: `apps/server/src/routers/search.ts`, extend existing routers
- **Search Components**: `apps/web/src/components/search/`
- **Organization Components**: `apps/web/src/components/organization/`

**Database Architecture**: [Source: architecture.md#Database Architecture]
- Extends existing content tables (notes, documents, audio_transcriptions)
- Many-to-many relationships for tags and folders
- Full-text search indexes for efficient content search
- Optimized queries for organization operations

**API Architecture (oRPC)**: [Source: architecture.md#API Architecture]
- **Server Side**: Context-aware procedures with authentication middleware
- **Client Side**: TanStack Query integration for search result caching
- Type-safe search operations with proper pagination
- Efficient organization operations with batch updates

**Frontend Architecture**: [Source: architecture.md#Frontend Architecture]
- **Component Structure**: Search and organization components following Shadcn-ui patterns
- **State Management**: TanStack Query for server state, React Context for search filters
- **Drag-and-Drop**: HTML5 drag-and-drop API with accessibility support
- **Virtualization**: Virtual scrolling for large search result sets

**AI Integration**: [Source: architecture.md#AI Integration]
- Existing Vercel AI SDK integration for tag generation
- Google AI SDK for content analysis and tag suggestions
- Consistent error handling and response formatting
- Integration with existing AI processing pipeline

### File Locations
- **Search Schema**: `apps/server/src/db/schema/search.ts`
- **Organization Schema**: `apps/server/src/db/schema/organization.ts`
- **Search Router**: `apps/server/src/routers/search.ts`
- **Search Components**: `apps/web/src/components/search/`
- **Organization Components**: `apps/web/src/components/organization/`
- **Search Pages**: `apps/web/src/app/search/`
- **E2E Tests**: `tests/e2e/search-organization.spec.ts`

### Technical Constraints
- Search performance must scale with content volume growth
- Organization operations should be efficient with large folder structures
- Full-text search indexes require careful maintenance and optimization
- Drag-and-drop must work across different content types consistently
- Must integrate seamlessly with all existing content types

### Dependencies
- **Required**: Stories 1.1, 1.2, and 1.3 must be completed for content integration
- **Builds on**: All existing content tables and AI infrastructure
- **Extends**: Content creation and viewing workflows from previous stories

### Search Implementation Details
- **Search Scope**: Notes content, document extracted text, voice transcriptions
- **Search Features**: Full-text search, filters, autocomplete, search suggestions
- **Performance**: Indexed search with pagination and result caching
- **Ranking**: Relevance scoring based on content type, recency, and user interaction

### Organization System Details
- **Tags**: User-created and AI-generated, color-coded, reusable across content types
- **Folders**: Hierarchical structure with unlimited nesting levels
- **Assignment**: Content can have multiple tags and belong to one folder
- **Operations**: Bulk operations for efficient content organization

### Performance Considerations
- Search indexes should be maintained efficiently during content updates
- Organization queries should be optimized for large folder hierarchies
- Search result pagination should handle large result sets effectively
- Tag and folder operations should support batch processing

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-28 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here after implementation*